<!DOCTYPE html>
<html>
<head>
<script src="lib/jquery-1.5.min.js"></script>
<style>
body {
    font-family: Helvetica Neue, Arial, Helvetica, sans-serif;
    width:700px;
    font-size:80%;
}

h1 {
    margin-bottom:0.15em;
    margin-top:0.1em;
    text-align:left;
}


table {
    width:700px;
    border-spacing:1px;
}

table thead th{
    background-color:#D7D7D7;
}

th {
    text-align:center;
    text-transform:uppercase;
}

td {
    text-align:right;
}

tbody tr:hover {
    background-color:#F1F1F1;
}

tbody tr {
    background-color:#E2E2E2;
}

th, td {
    padding:0.25em;
    
}

#progress_bar_total {
    position:relative;
    min-height:15px;    
    background-color:#F8C0C9;
    width:700px;
    z-index:0;
    margin-bottom:0.5em;
}

#progress_bar_done {
    z-index:1;
    position:absolute;
    top:0px;
    left:0px;
    background-color:#A0E4A0;
    min-height:15px;
    text-align:right;
    color:#138816;
    font-style:italic;
    padding-right:1em;
    overflow:hidden;
    white-space:nowrap;
    border-right:1px solid #1D650C;
}

#progress_bar_info {
    display:none;
    position:absolute;
    z-index:3;
    top:0px; left:0px;
    background-color:#ccc;
    opacity:0.86;
    min-height:15px;
    width:100%;
    text-align:center;
    color:black;
}

#tape {
    display:none;
    width:5em;
    min-height: 1.3em;
    right:5px;
    top:0px;
    position:absolute;
    font-weight:bold;
    font-size:110%;
    text-align:center;
    padding:0.25em;
    -webkit-border-radius: 2px;
    letter-spacing:0.1em;
}

div#tape.visible {
    display:block;
}

.selected, #tape {
    background-color:#545454;
    color:#FFF;
}

#tape:hover {
    cursor:default;
}

#tape img {
    position:absolute;
    right:-5px;
    top:-5px;
}

.data:hover {
    cursor:crosshair;
}

</style>
<script>
$(function() {
    chrome.tabs.getSelected(
        null,
        function(tab) {
            var port = chrome.tabs.connect(tab.id);
            port.postMessage({'question':'ping'});
            port.onMessage.addListener(
                function(o) {
                    var totalTimeUnits = o.totalDone + o.totalTodo + o.totalVerify + o.totalInProgress;
                    var percentComplete = Math.round((o.totalDone / totalTimeUnits)*100);
                    
                    // build out raw string for breakdown by story; screw fancy templates, i say (for now)
                    var storiesTable = "<table id='stories'><thead><tr><th>story</th><th>todo</th><th>in progress</th><th>verify</th><th>done</th></tr><tbody>";
                    var i = 0; numStories = o.stories.length;                   
                    for(i; i < numStories; i++) {
                        var story = o.stories[i];
                        storiesTable += "<tr>" +
                                            "<td>" + story.name + "</td>" +
                                            "<td class='data'>" + story.todo + "</td>" +
                                            "<td class='data'>" + story.inProgress + "</td>" +
                                            "<td class='data'>" + story.verify + "</td>" +
                                            "<td class='data'>" + story.done + "</td>" +
                                        "</tr>";
                    }
                    storiesTable += "</tbody></table>";
                    $('#output').html(  
                        "<div id='progress_bar_total'>" + 
                            "<div id='progress_bar_done' style='width:" + percentComplete + "%'>" + 
                                percentComplete + "% complete" +
                            "</div>" + 
                            "<div id='progress_bar_info'>" + o.totalDone + " (complete) / " + totalTimeUnits + " (total)</div>" +
                        "</div>"  +                                         
                        "<table>" +
                            "<thead>" +
                                "<tr><th>todo</th><th>in progress</th><th>verify</th><th>done</th></tr>" +
                            "</thead>" +
                            "<tbody>" +
                                "<tr>" +
                                    "<td>" + o.totalTodo + "</td>" +
                                    "<td>" + o.totalInProgress + "</td>" +
                                    "<td>" + o.totalVerify + "</td>" +
                                    "<td>" + o.totalDone + "</td>" +
                                "</tr>" +
                            "</tbody>" +
                        "</table>" +
                        "<div style='position:relative;'>" +
                            "<h2>Breakdown by Story</h2>" +                        
                            "<div id='tape'><div id='tape_inner'></div><img src='img/btn_close.png' /></div>" +
                            storiesTable +
                        "</div>"           
                    );
                    
                    $('#progress_bar_total').unbind();
                    
                    $('#progress_bar_total').hover(
                        function() {
                            $('#progress_bar_info').css('display', 'block');
                        },
                        function() {
                            $('#progress_bar_info').css('display', 'none');
                        }
                    );
                    
                    var customSum = 0;
                    $('table#stories td.data').click(
                            function() {
                                var v = parseFloat($(this).text());
                                
                                if($(this).hasClass('selected')) {
                                    customSum -= v;
                                    $('#tape_inner').text(customSum);
                                    $(this).removeClass('selected'); 
                                    if( 0 == $('table#stories').find('td.selected').length ) {
                                        $('#tape').removeClass('visible');
                                        customSum = 0;
                                    }                                 
                                } else {                                    
                                    customSum += v;
                                    $('#tape_inner').text(customSum);
                                    $(this).addClass('selected');
                                    if( ! $('#tape').hasClass('visible')) {
                                        $('#tape').addClass('visible');
                                    }
                                }

                            }
                        );
                    
                    $('#tape').click(
                        function() {
                            $('#tape_inner').text('');
                            $(this).removeClass('visible');
                            $('table#stories td.data').removeClass('selected');
                            customSum = 0;
                        }
                    );
                }
            );
        });        
    }
);
</script>
</head>

<body>
<h1>Scrumy Live Stats</h1>
<div id="output"></div>
</body>
</html>
